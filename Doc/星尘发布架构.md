# 星尘发布系统架构文档

本文档介绍星尘（Stardust）应用发布系统的完整架构设计、工作原理和代码实现。

## 一、系统概述

星尘发布系统是一个分布式应用部署管理平台，提供应用的自动化部署、版本管理、多节点发布等功能。系统采用集中控制、分布式执行的架构模式，支持将应用程序包发布到多个目标节点，并提供全生命周期的部署管理能力。

### 核心组件架构

```
┌───────────────────────────────────────────────────────────────────────┐
│                     Stardust.Web（控制台）                              │
│  ┌────────────────────────────────────────────────────────────────┐   │
│  │  AppDeployController  │  AppDeployNodeController  │  ...       │   │
│  └────────────────────────────────────────────────────────────────┘   │
└──────────────────────────────┬────────────────────────────────────────┘
                               │ HTTP API
┌──────────────────────────────┴────────────────────────────────────────┐
│                     Stardust.Server（服务端）                           │
│  ┌─────────────┐  ┌─────────────┐  ┌──────────────────────┐          │
│  │  AppDeploy  │  │AppDeployNode│  │  AppDeployVersion    │          │
│  │  应用部署集  │──│  应用节点    │──│     部署版本         │          │
│  └─────────────┘  └─────────────┘  └──────────────────────┘          │
│  ┌────────────────────────────────────────────────────────────────┐   │
│  │  DeployController  │  NodeController  │  DeployService  │...   │   │
│  └────────────────────────────────────────────────────────────────┘   │
└──────────────────────────┬────────────────────────────────────────────┘
                           │ HTTP API / WebSocket 长连接
        ┌──────────────────┼──────────────────┐
        ▼                  ▼                  ▼
┌───────────────┐   ┌───────────────┐   ┌───────────────┐
│  StarAgent    │   │  StarAgent    │   │  StarAgent    │
│  (Node A)     │   │  (Node B)     │   │  (Node C)     │
│ x64/net8.0    │   │ ARM/net10.0   │   │ x64/net10.0   │
└───────────────┘   └───────────────┘   └───────────────┘
```

## 二、数据模型

### 2.1 核心实体关系

```
AppDeploy (应用部署集)
    ├── AppDeployNode (应用节点) [1:N]
    ├── AppDeployVersion (部署版本) [1:N]
    ├── AppDeployHistory (部署历史) [1:N]
    ├── AppBuildNode (编译节点) [1:N]
    └── AppDeployResource (应用资源) [1:N]
        └── AppResource (部署资源)
            └── AppResourceVersion (资源版本)

Node (节点服务器)
    ├── AppDeployNode (应用节点) [1:N]
    └── NodeOnline (在线记录)
```

### 2.2 AppDeploy（应用部署集）

应用部署的核心配置，定义一个可部署的应用单元。通常与业务系统一一对应。

| 字段 | 说明 |
|------|------|
| Id | 编号 |
| ProjectId | 项目。资源归属的团队 |
| AppId | 应用ID。对应StarApp |
| Category | 类别 |
| Name | 应用名称，全局唯一（主键） |
| Enable | 是否启用 |
| Nodes | 节点数。该应用部署集所拥有的节点数 |
| Version | 当前使用的版本号 |
| **MultiVersion** | **多版本支持。支持多运行时版本，此时只认可部署版本中符合运行时要求的最新可用版本** |
| AutoPublish | 自动发布。应用版本后自动发布到启用节点 |
| PackageName | 包名。用于判断上传包名是否正确，避免错误上传其它应用包，支持*模糊匹配 |
| Port | 监听端口。应用自身监听的端口 |
| Urls | 服务地址。对外提供服务的域名端口地址，自动生成nginx配置 |
| Repository/Branch | 代码库配置（用于自动编译） |
| ProjectPath | 项目路径。需要编译的项目路径 |
| ProjectKind | 项目类型。默认dotnet |
| FileName | 启动文件名，支持 zip 包 |
| Arguments | 启动参数 |
| WorkingDirectory | 工作目录 |
| UserName | 运行用户 |
| Environments | 环境变量 |
| MaxMemory | 内存限制（MB），超过自动重启 |
| Priority | 优先级。进程或任务的优先级级别 |
| Mode | 工作模式：Standard(10)/Shadow(11)/Hosted(12)/Task(13) |
| AllowMultiple | 是否允许多实例。同一应用可在本机运行多份进程 |
| AutoStop | 是否随宿主退出 |
| ReloadOnChange | 文件变化时是否重启 |

**关键特性**：
- **MultiVersion 模式**：开启后，不同节点可以运行不同版本（根据 OS/Arch/TargetFramework 自动匹配）
- **AutoPublish 模式**：版本创建后自动发布到所有启用节点
- **差异化配置**：节点级配置可覆盖应用集配置

### 2.3 AppDeployNode（应用节点）

应用和节点服务器的关联关系，支持单应用多节点部署。一个应用部署集可以关联多个节点。

| 字段 | 说明 |
|------|------|
| Id | 编号（**发布时使用的 deployId**） |
| DeployName | 发布名。默认为空使用部署集名字。可用于单节点多发布场景 |
| DeployId | 关联的应用部署集 |
| NodeId | 关联的节点服务器 |
| IP | IP地址。节点所在内网IP地址 |
| Enable | 是否启用 |
| Version | 当前使用的版本。开启MultiVersion时可能不同节点使用不同版本 |
| Resources | 资源版本。最后一次发布时携带的资源名称和版本，格式如 `dm8-driver:1.0;newlifex-cert:2025.01` |
| Port | 应用端口。应用自身监听的端口 |
| FileName | 启动文件（覆盖应用配置） |
| Arguments | 启动参数（覆盖应用配置） |
| WorkingDirectory | 工作目录（覆盖应用配置） |
| UserName | 运行用户（覆盖应用配置） |
| Environments | 环境变量（覆盖应用配置） |
| MaxMemory | 最大内存（覆盖应用配置） |
| Priority | 优先级（覆盖应用配置） |
| Mode | 部署模式（覆盖应用配置） |
| Delay | 延迟。批量发布时，需要延迟执行的时间，用于滚动发布，单位秒 |
| ProcessId | 当前运行的进程ID |
| ProcessName | 进程名称 |
| ProcessUser | 进程用户。启动该进程的用户名 |
| StartTime | 进程时间 |
| Compile | 编译时间。客户端 |
| Listens | 监听端口。网络端口监听信息 |
| LastActive | 最后活跃。最后一次上报心跳的时间 |
| LastUpload | 最后上传。最后一次上传客户端配置的时间 |

**关键特性**：
- **节点级配置**：支持覆盖应用集配置（FileName、Arguments、Environments 等）
- **运行状态**：记录节点上应用的运行状态（ProcessId、LastActive）
- **滚动发布**：Delay 字段支持分批次发布

### 2.4 AppDeployVersion（部署版本）

应用的版本管理，支持多版本切换。每个版本管理一个应用程序包（ZIP）。

| 字段 | 说明 |
|------|------|
| Id | 编号 |
| DeployId | 关联的应用部署集 |
| Version | 版本号，如 `2.3.2022.0911`，字符串比较大小 |
| Enable | 是否启用 |
| Url | 资源地址（zip 包）。如 `/cube/file?id=123.zip` |
| Overwrite | 覆盖文件。需要拷贝覆盖已存在的文件或子目录，支持*模糊匹配 |
| Mode | 发布模式。1部分包，仅覆盖；2标准包，清空可执行文件再覆盖；3完整包，清空所有文件 |
| Size | 文件大小 |
| Hash | 文件哈希（MD5）。避免下载的文件有缺失 |
| **OS** | **操作系统。目标操作系统，为0表示通用** |
| **Arch** | **CPU架构。目标指令集架构，为0表示通用** |
| **TargetFramework** | **目标框架。TFM目标运行时框架，如 `net8.0`** |
| Progress | 进度。发布进度 |
| CommitId | 提交标识（用于自动编译） |
| CommitLog | 提交记录（用于自动编译） |
| CommitTime | 提交时间（用于自动编译） |

**版本匹配机制**（核心特性）：
- **MultiVersion 模式关闭**：使用 `AppDeploy.Version` 字段指定的版本
- **MultiVersion 模式开启**：根据节点的 OS/Arch/Frameworks 自动选择最新匹配版本
  - 匹配顺序：操作系统 → CPU架构 → 运行时框架
  - 通用版本（OS=0, Arch=0）可匹配所有节点
  - 框架版本向上兼容（如 net4.6.1 可运行在 net4.7/net4.8 上）

**典型场景**：
```
应用部署集：MyApp (MultiVersion=true)
├── 版本 1.0.0-x64-net8.0    (OS=Windows, Arch=X64, TFM=net8.0)
├── 版本 1.0.0-arm64-net8.0  (OS=Linux, Arch=Arm64, TFM=net8.0)
├── 版本 1.0.0-x64-net10.0   (OS=Windows, Arch=X64, TFM=net10.0)
└── 版本 1.0.0-universal     (OS=Any, Arch=Any, TFM=)

节点A (Windows/X64/net10.0) → 自动选择 1.0.0-x64-net10.0
节点B (Linux/Arm64/net8.0)  → 自动选择 1.0.0-arm64-net8.0
节点C (Linux/X86/net6.0)    → 自动选择 1.0.0-universal
```

## 部署模式

系统支持四种部署模式，通过 `DeployMode` 枚举定义：

| 模式 | 值 | 说明 |
|------|-----|------|
| **Default** | 0 | 默认模式，兼容旧版，等同于 Shadow |
| **Standard** | 10 | 标准模式，解压到工作目录，直接运行 |
| **Shadow** | 11 | 影子模式，解压到影子目录，工作目录保持干净 |
| **Hosted** | 12 | 托管模式，仅解压，由外部宿主（IIS/Nginx）运行 |
| **Task** | 13 | 任务模式，运行一次后完成，不守护 |

### 模式选择建议

```
Standard (10) - 推荐，简单直接
├── 适合：大多数应用
├── 特点：zip 解压到工作目录，直接运行
└── 场景：控制台应用、Web API、后台服务

Shadow (11) - 热更新场景
├── 适合：需要保持配置文件的应用
├── 特点：可执行文件在影子目录，配置在工作目录
└── 场景：频繁更新但配置不变的应用

Hosted (12) - 外部托管
├── 适合：IIS/Nginx 托管的应用
├── 特点：仅解压，不启动进程
└── 场景：ASP.NET 应用、静态网站

Task (13) - 一次性任务
├── 适合：脚本、迁移工具
├── 特点：运行后自动禁用
└── 场景：数据库迁移、初始化脚本
```

## 客户端架构

### 组件关系

```
┌─────────────────────────────────────────────────────────────┐
│                      ServiceManager                          │
│  ┌─────────────────────────────────────────────────────────┐│
│  │ - 管理多个 ServiceController                            ││
│  │ - 处理服务端指令（安装/卸载/启动/停止/重启）             ││
│  │ - 定时健康检查                                          ││
│  │ - 上报/拉取应用配置                                     ││
│  └─────────────────────────────────────────────────────────┘│
└──────────────────────────┬──────────────────────────────────┘
                           │ 1:N
        ┌──────────────────┼──────────────────┐
        ▼                  ▼                  ▼
┌───────────────┐  ┌───────────────┐  ┌───────────────┐
│ServiceController│ │ServiceController│ │ServiceController│
│   (App A)     │  │   (App B)     │  │   (App C)     │
└───────┬───────┘  └───────┬───────┘  └───────┬───────┘
        │                  │                  │
        ▼                  ▼                  ▼
┌───────────────┐  ┌───────────────┐  ┌───────────────┐
│IDeployStrategy│  │IDeployStrategy│  │IDeployStrategy│
│  (Standard)   │  │   (Shadow)    │  │   (Hosted)    │
└───────────────┘  └───────────────┘  └───────────────┘
```

### ServiceManager

应用服务管理器，负责整体调度：

```csharp
public class ServiceManager
{
    // 应用服务集合
    public ServiceInfo[] Services { get; }
    
    // 正在运行的控制器
    private List<ServiceController> _controllers;
    
    // 核心方法
    void Start();                    // 启动管理
    void Stop(String reason);        // 停止管理
    Boolean StartService(...);       // 启动服务
    Boolean StopService(...);        // 停止服务
    
    // 服务端指令处理
    Task<Boolean> OnInstall(...);    // 安装/发布
    Boolean OnStart(...);            // 启动
    Boolean OnStop(...);             // 停止
    Boolean OnRestart(...);          // 重启
    Boolean OnUninstall(...);        // 卸载
}
```

### ServiceController

单个应用的生命周期控制器：

```csharp
public class ServiceController
{
    public String Name { get; }           // 服务名
    public ServiceInfo Info { get; }      // 服务配置
    public Process Process { get; }       // 进程实例
    public Boolean Running { get; }       // 运行状态
    
    public Boolean Start();               // 启动应用
    public void Stop(String reason);      // 停止应用
    public Boolean Check();               // 检查并接管/重启
}
```

### IDeployStrategy

部署策略接口，实现不同的部署行为：

```csharp
public interface IDeployStrategy
{
    DeployMode Mode { get; }              // 部署模式
    Boolean NeedGuardian { get; }         // 是否需要守护
    Boolean AllowTakeOver { get; }        // 是否允许接管
    
    Boolean Extract(DeployContext ctx);   // 解压部署包
    Process Execute(DeployContext ctx);   // 执行应用
}
```

## 部署流程

### 1. 上传应用包

```
用户 ──[上传 zip]──> Stardust.Server ──[保存]──> AppDeployVersion
                          │
                          ▼
                    记录版本信息
                    - Version: 1.0.0
                    - Url: /files/app.zip
                    - Hash: MD5值
                    - Size: 文件大小
```

### 2. 发布指令

```
管理员 ──[点击发布]──> Stardust.Server
                          │
                          ▼
                    查询 AppDeployNode
                    找到目标节点
                          │
                          ▼
              ┌───────────┴───────────┐
              ▼                       ▼
        WebSocket 推送           HTTP 轮询
        deploy/publish           GetDeploy API
              │                       │
              └───────────┬───────────┘
                          ▼
                      StarAgent
```

### 3. 客户端处理

```
StarAgent 收到指令
        │
        ▼
ServiceManager.DoControl()
        │
        ├── deploy/publish ──> OnInstall()
        ├── deploy/install ──> OnInstall()
        ├── deploy/start   ──> OnStart()
        ├── deploy/stop    ──> OnStop()
        ├── deploy/restart ──> OnRestart()
        └── deploy/uninstall -> OnUninstall()
```

### 4. 安装流程（OnInstall）

```
OnInstall(deployId, serviceName, appName)
        │
        ▼
PullService() ──[HTTP]──> 服务端 GetDeploy API
        │
        ▼
返回 DeployInfo[]
├── DeployInfo.Service (ServiceInfo)
│   ├── Name: 服务名
│   ├── FileName: 启动文件
│   ├── Arguments: 启动参数
│   ├── WorkingDirectory: 工作目录
│   ├── Mode: 部署模式
│   └── Enable: 是否启用
│
└── DeployInfo
    ├── Id: 部署节点ID
    ├── Name: 应用名
    ├── Version: 版本号
    ├── Url: 下载地址
    └── Hash: 文件哈希
        │
        ▼
Download() ──[HTTP]──> 下载 zip 包到工作目录
        │
        ├── 检查本地文件是否存在
        ├── 比对 Hash 是否一致
        ├── 下载到临时目录
        ├── 校验哈希
        └── 移动到目标位置
        │
        ▼
StopService() ──> 停止旧进程
        │
        ▼
StartService(svc, deploy)
        │
        ▼
ServiceController.Start()
        │
        ▼
DeployStrategyFactory.Create(mode)
        │
        ├── Standard(10) ──> StandardDeployStrategy
        ├── Shadow(11)   ──> ShadowDeployStrategy
        ├── Hosted(12)   ──> HostedStrategy
        └── Task(13)     ──> TaskStrategy
        │
        ▼
strategy.Extract(context)
        │
        ├── 解压 zip 到目标目录
        ├── 查找可执行文件
        └── 设置 context.ExecuteFile
        │
        ▼
strategy.Execute(context)
        │
        ├── 构建 ProcessStartInfo
        ├── 设置环境变量
        ├── 注入星尘监控（可选）
        ├── 启动进程
        └── 返回 Process 实例
        │
        ▼
SetProcess(p) ──> 记录进程信息
        │
        ▼
StartMonitor() ──> 启动文件监控
```

### 5. 数据流转

```
服务端数据                           客户端数据
─────────────                        ─────────────
AppDeploy ────┐
              │
AppDeployNode─┼──[ToServiceInfo()]──> ServiceInfo
              │                            │
              │                            ▼
AppDeployVersion ──[构建 DeployInfo]──> DeployInfo
                                           │
                                           ▼
                                    DeployContext
                                           │
                                           ▼
                                    IDeployStrategy
```

## 策略模式实现

### StandardDeployStrategy（标准模式）

```
工作目录结构：
apps/myapp/
├── myapp.zip          # 下载的应用包
├── myapp.exe          # 解压后的可执行文件
├── myapp.dll
├── appsettings.json   # 配置文件
└── logs/              # 日志目录

执行流程：
1. Extract: zip 解压到工作目录
2. Execute: 直接在工作目录运行
```

### ShadowDeployStrategy（影子模式）

```
目录结构：
apps/myapp/              # 工作目录（配置和数据）
├── myapp.zip
├── appsettings.json
└── data/

shadow/myapp-a1b2c3d4/   # 影子目录（可执行文件）
├── myapp.exe
├── myapp.dll
└── *.dll

执行流程：
1. Extract: zip 解压到影子目录
2. 配置文件拷贝到工作目录（如不存在）
3. Execute: 在影子目录运行，工作目录设为 apps/myapp
```

### HostedStrategy（托管模式）

```
工作目录结构：
wwwroot/mysite/
├── web.config         # IIS 配置
├── app_offline.htm    # 维护页面（部署时临时创建）
├── *.dll
└── wwwroot/

执行流程：
1. Extract:
   - 创建 app_offline.htm（网站离线）
   - 备份 web.config
   - 解压 zip 到工作目录
   - 恢复 web.config
   - 删除 app_offline.htm（网站上线）
2. Execute: 不启动进程（由 IIS 托管）
```

### TaskStrategy（任务模式）

```
执行流程：
1. Extract: zip 解压到工作目录（如有）
2. Execute: 运行一次
3. 完成后: 设置 Enable = false，不再守护
```

## 守护机制

ServiceManager 通过定时器（30秒）进行健康检查：

```
DoWork() 定时任务
        │
        ▼
遍历 Services
        │
        ├── 服务已禁用 ──> StopService()
        │
        ├── 配置已改变 ──> Stop + Start
        │
        └── 服务已启用 ──> StartService()
                │
                ▼
        ServiceController.Check()
                │
                ├── 进程存在 ──> 检查内存限制
                │       │
                │       └── 超限 ──> Stop + Start
                │
                ├── 进程不存在但有 ProcessId
                │       │
                │       └── 尝试按 ID 查找并接管
                │
                ├── 进程不存在但有 ProcessName
                │       │
                │       └── 尝试按名称查找并接管
                │
                └── 都找不到 ──> Start() 启动新进程
```

## 兼容性设计

### 新旧模式兼容

系统支持新旧两套部署模式值：

| 旧版值 | 旧版名称 | 新版值 | 新版名称 |
|--------|----------|--------|----------|
| 0 | Default | 11 | Shadow |
| 1 | Extract | 12 | Hosted |
| 2 | ExtractAndRun | 10 | Standard |
| 3 | RunOnce | 13 | Task |
| 4 | Multiple | 11 | Shadow + AllowMultiple |

客户端通过数值范围自动识别：
- 0-9：旧版模式，按映射表转换
- 10+：新版模式，直接使用

```csharp
public static IDeployStrategy Create(DeployMode mode)
{
    var value = (Int32)mode;
    
    // 新版模式 10+
    if (value >= 10)
    {
        return mode switch
        {
            DeployMode.Standard => new StandardDeployStrategy(),
            DeployMode.Shadow => new ShadowDeployStrategy(),
            DeployMode.Hosted => new HostedStrategy(),
            DeployMode.Task => new TaskStrategy(),
            _ => new StandardDeployStrategy(),
        };
    }
    
    // 旧版模式 0-4，映射到新版策略
    return value switch
    {
        0 => new ShadowDeployStrategy(),      // Default -> Shadow
        1 => new HostedStrategy(),            // Extract -> Hosted
        2 => new StandardDeployStrategy(),    // ExtractAndRun -> Standard
        3 => new TaskStrategy(),              // RunOnce -> Task
        4 => new ShadowDeployStrategy(),      // Multiple -> Shadow
        _ => new ShadowDeployStrategy(),
    };
}
```

### 服务端兼容

服务端数据库继续使用旧的 `ServiceModes` 字段存储，在下发时转换为数值。

新版客户端（>=v3.7）：接收新版模式值（10+）
旧版客户端（<v3.7）：接收旧版模式值（0-4）

## 三、多版本管理与回滚

### 3.1 MultiVersion 模式

**核心机制**：
- 开启 `AppDeploy.MultiVersion = true`
- 上传版本时标识 OS、Arch、TargetFramework
- GetAll 接口自动根据节点平台选择最新的匹配版本

**版本选择规则**：
1. 过滤 `Enable = true` 的版本
2. 按 ID 倒序排列（最新优先）
3. 匹配节点的 OS、Arch、Frameworks
4. 返回第一个匹配的版本

### 3.2 版本回滚方案

#### 方案一：禁用新版本（推荐）

**原理**：利用现有的 `Enable` 字段过滤机制

**操作步骤**：
```
场景：想回滚到 2024-12-20 的版本

版本列表：
- ID=100, Version=1.0.0, Arch=Arm64, CreateTime=2025-01-15, Enable=true  (最新)
- ID=50,  Version=1.0.0, Arch=Arm64, CreateTime=2024-12-20, Enable=true  (目标)

回滚方法：
1. 找到 ID=100 的版本，点击"禁用"
2. 点击"发布"按钮
3. 系统自动选择 ID=50（最新的可用版本）
```

**优点**：
- ✅ 不需要修改代码
- ✅ 不需要新增字段
- ✅ 操作简单直观
- ✅ 支持灰度回滚（逐步禁用不同平台的新版本）
- ✅ 可随时恢复（重新启用即可）

**适用场景**：
- 单平台回滚（如只回滚 ARM 版本）
- 灰度回滚（先回滚部分节点）
- 临时回滚（测试后可恢复）

#### 方案二：版本命名规范

**建议规范**：版本号包含日期或构建号
```
格式：{主版本}.{次版本}.{年}.{月日}
示例：1.0.2025.0115、1.0.2024.1220

优点：
- 版本号天然有序
- 易于识别发布时间
- 直接使用版本号回滚
```

#### 方案三：控制台增强（未来优化）

在版本列表页面增加快捷操作：
- "回滚到此版本"按钮：自动禁用所有比它新的版本
- "预览回滚"功能：显示每个节点将使用的版本
- 批量操作：同时禁用多个平台的新版本

### 3.3 回滚场景示例

#### 场景1：单平台回滚

```
应用：MyApp (MultiVersion=true)
版本列表：
- ID=101, v1.0.0, Windows/X64,  2025-01-15, Enable=true
- ID=100, v1.0.0, Linux/Arm64,  2025-01-15, Enable=true  ← 有问题，需要回滚
- ID=51,  v1.0.0, Windows/X64,  2024-12-20, Enable=true
- ID=50,  v1.0.0, Linux/Arm64,  2024-12-20, Enable=true  ← 稳定版本

操作：
1. 禁用 ID=100
2. 发布

结果：
- Windows 节点继续使用 ID=101
- ARM 节点自动回滚到 ID=50
```

#### 场景2：全平台回滚

```
需求：所有平台回滚到 2024-12-20 版本

操作：
1. 禁用所有 2024-12-20 之后的版本（ID=100, 101）
2. 发布

结果：
- 所有节点都使用 2024-12-20 的版本
```

#### 场景3：灰度回滚

```
需求：先回滚测试环境，验证后再回滚生产环境

操作：
1. 在测试节点上禁用新版本
2. 观察测试节点运行情况
3. 确认无问题后，在生产节点上禁用新版本
```

### 3.4 版本管理最佳实践

1. **版本命名规范**：
   - 包含日期：`1.0.2025.0115`
   - 包含平台标识：文件名如 `myapp-win-x64.zip`

2. **上传版本时**：
   - 填写准确的 OS、Arch、TargetFramework
   - 使用描述字段记录变更内容
   - 标记特殊版本（如 LTS、Beta）

3. **回滚操作**：
   - 优先使用"禁用"方式回滚
   - 保留回滚历史记录
   - 在部署历史中记录回滚原因

4. **版本清理**：
   - 定期清理过旧的版本
   - 保留重要里程碑版本
   - 禁用而不是删除问题版本

## 四、资源管理

### 4.1 资源类型

系统支持管理附加资源，随应用一起发布：

| 类型 | 示例 | 用途 |
|------|------|------|
| driver | dm8-driver | 数据库驱动 |
| cert | newlifex-cert | SSL 证书 |
| config | nginx-template | 配置模板 |
| plugin | log-plugin | 日志插件 |

### 4.2 资源版本匹配

与应用版本类似，资源也支持多平台版本：
- 根据 OS/Arch 自动选择
- 支持通用版本（OS=0, Arch=0）
- 发布时一并下发到目标节点

### 4.3 资源发布流程

```
1. 创建资源（AppResource）
2. 上传资源版本（AppResourceVersion）
3. 关联到应用（AppDeployResource）
4. 发布时指定资源列表
5. 自动下发到目标节点
```

## 五、配置文件

### StarAgentSetting.xml

客户端配置文件中的 Services 节点：

```xml
<StarAgentSetting>
  <Services>
    <ServiceInfo Name="myapp" 
                 FileName="myapp.zip" 
                 WorkingDirectory="../apps/myapp"
                 Mode="Standard"
                 Enable="True"
                 AutoStop="False"
                 ReloadOnChange="True"
                 MaxMemory="512" />
  </Services>
</StarAgentSetting>
```

Mode 属性支持枚举名称（Standard/Shadow/Hosted/Task）或数值（10/11/12/13）。

## 六、总结

星尘发布系统通过策略模式和智能版本匹配实现了灵活的部署方式，核心特性：

1. **多种部署模式**：标准/影子/托管/任务
2. **分布式部署**：一个应用可部署到多个节点
3. **智能版本管理**：支持多平台版本自动匹配
4. **进程守护**：自动重启崩溃的应用
5. **热更新**：文件变化自动重启
6. **内存限制**：超限自动重启
7. **兼容性**：新旧版本平滑过渡
8. **资源管理**：支持附加资源（驱动、证书等）
9. **滚动发布**：支持分批次延迟发布

**完整的代码链路**：
```
控制台上传 → 保存附件 → 解析元数据 → 记录版本
         ↓
点击发布 → 生成命令 → 下发指令 → WebSocket 推送
         ↓
客户端接收 → 拉取信息 → GetAll 接口 → 智能匹配版本
         ↓
下载 ZIP → 解压部署 → 启动进程 → 守护监控
```

整体架构清晰，扩展性强，适合中大型分布式系统的应用部署管理。
