# 星尘发布系统架构文档

> **版本**：v3.7+ | **更新时间**：2026-02-06 | **文档状态**：最新稳定版

本文档介绍星尘（Stardust）应用发布系统的完整架构设计、工作原理、核心特性和最佳实践。

---

## 目录

1. [系统概述](#一系统概述)
2. [核心架构](#二核心架构)
3. [数据模型](#三数据模型)
4. [部署模式](#四部署模式)
5. [多版本管理](#五多版本管理)
6. [SSL证书管理](#六ssl证书管理)
7. [依赖项管理](#七依赖项管理)
8. [部署流程](#八部署流程)
9. [客户端架构](#九客户端架构)
10. [最佳实践](#十最佳实践)
11. [故障排查](#十一故障排查)

---

## 一、系统概述

### 1.1 核心定位

星尘发布系统是一个**分布式应用部署管理平台**，提供应用的自动化部署、版本管理、多节点发布等功能。系统采用集中控制、分布式执行的架构模式，支持将应用程序包发布到多个目标节点，并提供全生命周期的部署管理能力。

### 1.2 核心特性

| 特性 | 说明 |
|------|------|
| **多版本管理** | 支持多平台版本自动匹配（OS/Arch/TFM），一键回滚 |
| **分布式部署** | 一个应用可部署到多个节点，支持滚动发布 |
| **多种部署模式** | Standard/Shadow/Hosted/Task，适应不同场景 |
| **进程守护** | 自动重启崩溃的应用，内存超限自动重启 |
| **SSL证书管理** | 自动匹配证书，支持自动续期和多格式 |
| **依赖项管理** | 驱动/插件作为独立部署集，自动检查和部署 |
| **热更新** | 文件变化自动重启，支持影子模式 |
| **兼容性强** | 新旧版本平滑过渡，支持 .NET Framework 4.5+ 到 .NET 10+ |

### 1.3 设计原则

```
1. 简洁性 - 删除不必要的字段和关联，简化操作
2. 自动化 - 证书自动匹配、依赖自动部署、版本自动选择
3. 复用性 - 驱动/插件复用平台能力，避免重复造轮子
4. 灵活性 - 支持全局/项目级资源，节点级配置覆盖
5. 可靠性 - 进程守护、内存限制、文件监控、回滚机制
```

---

## 二、核心架构

### 2.1 系统架构图

```
┌───────────────────────────────────────────────────────────────────────┐
│                     Stardust.Web（管理控制台）                          │
│  ┌────────────────────────────────────────────────────────────────┐   │
│  │  AppDeployController  │  AppDeployNodeController  │  ...       │   │
│  │  上传版本 | 配置应用 | 批量发布 | 查看状态 | 回滚版本           │   │
│  └────────────────────────────────────────────────────────────────┘   │
└──────────────────────────────┬────────────────────────────────────────┘
                               │ HTTP API
┌──────────────────────────────┴────────────────────────────────────────┐
│                     Stardust.Server（服务端）                           │
│  ┌─────────────────────────────────────────────────────────────────┐  │
│  │  数据层                                                          │  │
│  │  ├── AppDeploy（应用部署集）                                    │  │
│  │  ├── AppDeployNode（应用节点）                                  │  │
│  │  ├── AppDeployVersion（部署版本）                               │  │
│  │  └── SslCertificate（SSL证书）                                  │  │
│  └─────────────────────────────────────────────────────────────────┘  │
│  ┌─────────────────────────────────────────────────────────────────┐  │
│  │  服务层                                                          │  │
│  │  ├── DeployService（版本匹配、证书匹配、依赖检查）              │  │
│  │  ├── NodeService（节点管理、心跳监控）                          │  │
│  │  └── CertRenewJob（证书自动续期）                               │  │
│  └─────────────────────────────────────────────────────────────────┘  │
│  ┌─────────────────────────────────────────────────────────────────┐  │
│  │  接口层                                                          │  │
│  │  ├── DeployController（/deploy/publish、/deploy/start...）      │  │
│  │  ├── NodeController（/node/ping、/node/getDeploy...）           │  │
│  │  └── WebSocket（实时推送发布指令）                              │  │
│  └─────────────────────────────────────────────────────────────────┘  │
└──────────────────────────┬────────────────────────────────────────────┘
                           │ HTTP API / WebSocket 长连接
        ┌──────────────────┼──────────────────┐
        ▼                  ▼                  ▼
┌───────────────┐   ┌───────────────┐   ┌───────────────┐
│  StarAgent    │   │  StarAgent    │   │  StarAgent    │
│  (Node A)     │   │  (Node B)     │   │  (Node C)     │
│ x64/net8.0    │   │ ARM/net10.0   │   │ x64/net10.0   │
│               │   │               │   │               │
│ ServiceManager│   │ ServiceManager│   │ ServiceManager│
│ ├─ MyApp      │   │ ├─ MyApp      │   │ ├─ MyApp      │
│ ├─ dm8-driver │   │ ├─ dm8-driver │   │ ├─ dm8-driver │
│ └─ redis-plugin│  │ └─ redis-plugin│  │ └─ redis-plugin│
└───────────────┘   └───────────────┘   └───────────────┘
```

### 2.2 核心组件关系

```
AppDeploy (应用部署集)
    ├── AppDeployNode (应用节点) [1:N]
    │   └── Node (节点服务器)
    ├── AppDeployVersion (部署版本) [1:N]
    ├── AppDeployHistory (部署历史) [1:N]
    └── AppBuildNode (编译节点) [1:N]

SslCertificate (SSL证书)
    └── 通过 Domain 字段匹配 AppDeploy.Urls（自动匹配）
```

### 2.3 数据流转

```
管理控制台                           服务端                           客户端
──────────                          ─────────                        ─────────
上传 ZIP 包                                                              
    │                                                                    
    └──> AppDeployVersion.Url                                           
                                                                         
配置应用                                                                 
    │                                                                    
    ├──> AppDeploy.Name                                                 
    ├──> AppDeploy.Urls ──> 自动匹配 ──> SslCertificate.Domain          
    └──> AppDeploy.Dependencies                                         
                                                                         
点击发布                                                                 
    │                                                                    
    └──> DeployService                                                  
            ├── 选择版本（MultiVersion匹配）                            
            ├── 查找证书（Domain匹配）                                   
            ├── 检查依赖（自动关联）                                     
            └── 构建 DeployInfo                                         
                    │                                                    
                    └──> WebSocket/HTTP ──> StarAgent                   
                                                ├── ServiceManager       
                                                ├── Download ZIP         
                                                ├── Extract              
                                                ├── Deploy SSL Cert      
                                                ├── Deploy Dependencies  
                                                └── Start Process        
```

---

## 三、数据模型

### 3.1 AppDeploy（应用部署集）

应用部署的核心配置，定义一个可部署的应用单元。

**核心字段**：

| 字段 | 类型 | 说明 |
|------|------|------|
| **Id** | Int32 | 编号 |
| **Name** | String | 应用名称，全局唯一（主键），如 `myapp` |
| ProjectId | Int32 | 项目。资源归属的团队，0表示全局 |
| Category | String | 类别。如 `app`/`driver`/`plugin` |
| Enable | Boolean | 是否启用 |
| **Version** | String | 当前使用的版本号，如 `1.0.2025.0701` |
| **MultiVersion** | Boolean | **多版本支持**。开启后根据节点平台自动选择最新匹配版本 |
| AutoPublish | Boolean | 自动发布。版本创建后自动发布到启用节点 |
| **Urls** | String | 服务地址。如 `https://sso.newlifex.com`，用于自动匹配SSL证书 |
| **Dependencies** | String | 依赖项。如 `dm8-driver;redis-plugin`，分号分隔 |
| FileName | String | 启动文件名，支持 zip 包 |
| Arguments | String | 启动参数 |
| WorkingDirectory | String | 工作目录 |
| Environments | String | 环境变量 |
| MaxMemory | Int32 | 最大内存（MB），超过自动重启 |
| Mode | DeployMode | 工作模式：Standard(10)/Shadow(11)/Hosted(12)/Task(13) |
| AllowMultiple | Boolean | 允许多实例。同一应用可在本机运行多份进程 |
| ReloadOnChange | Boolean | 文件变化时是否重启 |

**关键特性**：

1. **MultiVersion 模式**：
   - 开启后，不同节点可运行不同版本（根据 OS/Arch/TargetFramework 自动匹配）
   - 关闭时，所有节点使用 `Version` 字段指定的版本

2. **AutoPublish 模式**：
   - 版本创建后自动发布到所有启用节点
   - 加快发布速度，无需手动操作

3. **差异化配置**：
   - 节点级配置可覆盖应用集配置
   - 支持单节点多发布场景（通过 DeployName 区分）

### 3.2 AppDeployNode（应用节点）

应用和节点服务器的关联关系，支持单应用多节点部署。

**核心字段**：

| 字段 | 类型 | 说明 |
|------|------|------|
| **Id** | Int32 | 编号（**发布时使用的 deployId**） |
| **DeployId** | Int32 | 关联的应用部署集 |
| **NodeId** | Int32 | 关联的节点服务器 |
| Enable | Boolean | 是否启用 |
| **Version** | String | 当前使用的版本。开启MultiVersion时可能不同节点使用不同版本 |
| Resources | String | 资源版本。最后一次发布时携带的资源，如 `dm8-driver:1.0;cert:2025.01` |
| FileName/Arguments/... | String | 节点级配置。覆盖应用集配置 |
| Delay | Int32 | 延迟。批量发布时的延迟时间，用于滚动发布（秒） |
| **ProcessId** | Int32 | 当前运行的进程ID |
| **LastActive** | DateTime | 最后活跃。最后一次上报心跳的时间 |

**关键特性**：

- **节点级覆盖**：FileName、Arguments、Environments 等可覆盖应用集配置
- **运行状态**：记录节点上应用的运行状态（ProcessId、LastActive）
- **滚动发布**：Delay 字段支持分批次延迟发布

### 3.3 AppDeployVersion（部署版本）

应用的版本管理，支持多版本切换。

**核心字段**：

| 字段 | 类型 | 说明 |
|------|------|------|
| **Id** | Int32 | 编号 |
| **DeployId** | Int32 | 关联的应用部署集 |
| **Version** | String | 版本号，如 `1.0.2025.0701`，字符串比较大小 |
| Enable | Boolean | 是否启用（用于回滚） |
| **Url** | String | 资源地址（zip 包）。如 `/cube/file?id=123.zip` |
| **Hash** | String | 文件哈希（MD5）。避免下载的文件有缺失 |
| **OS** | OSKind | 操作系统。Windows/Linux/..., 0表示通用 |
| **Arch** | CpuArch | CPU架构。X64/Arm64/..., 0表示通用 |
| **TargetFramework** | String | 目标框架。TFM目标运行时框架，如 `net8.0` |
| Overwrite | String | 覆盖文件。需要拷贝覆盖的文件，支持*模糊匹配 |
| Mode | DeployModes | 发布模式。1部分包，2标准包，3完整包 |

**版本匹配机制**（MultiVersion 核心）：

```
1. 过滤 Enable=true 的版本
2. 按 ID 倒序排列（最新优先）
3. 匹配节点的 OS、Arch、Frameworks
4. 返回第一个匹配的版本

匹配规则：
- OS/Arch/TFM 全部为 0 → 通用版本，匹配所有节点
- OS 匹配 → CPU架构匹配 → 运行时框架匹配（向上兼容）
- 优先精确匹配，其次通用版本
```

**典型场景**：

```
应用：MyApp (MultiVersion=true)
版本列表：
├── v1.0.0 (OS=Windows, Arch=X64, TFM=net8.0)   ID=101
├── v1.0.0 (OS=Linux, Arch=Arm64, TFM=net8.0)   ID=100
├── v1.0.0 (OS=Windows, Arch=X64, TFM=net10.0)  ID=102
└── v1.0.0 (OS=Any, Arch=Any, TFM=)             ID=99

节点A (Windows/X64/net10.0)  → 选择 ID=102
节点B (Linux/Arm64/net8.0)   → 选择 ID=100
节点C (Linux/X86/net6.0)     → 选择 ID=99（通用）
```

### 3.4 SslCertificate（SSL证书）

SSL证书专用表，集中管理企业的HTTPS证书。

**核心字段**：

| 字段 | 类型 | 说明 |
|------|------|------|
| **Id** | Int32 | 编号 |
| **Domain** | String | 域名（单数）。支持通配符，如 `*.newlifex.com` |
| Enable | Boolean | 是否启用 |
| **PfxFile** | String | PFX文件（Windows/IIS），魔方附件管理，长度50 |
| PfxPassword | String | PFX密码，加密存储 |
| **CrtFile** | String | 证书文件（Linux/Nginx），魔方附件管理，长度50 |
| **KeyFile** | String | 私钥文件（Linux/Nginx），魔方附件管理，长度50 |
| **PemFile** | String | PEM文件（通用格式），魔方附件管理，长度50 |
| **NotBefore** | DateTime | 生效时间 |
| **NotAfter** | DateTime | 过期时间。用于自动告警和续期 |
| AutoRenew | Boolean | 自动续期。集成Let's Encrypt/阿里云等 |
| Provider | String | 证书提供商。letsencrypt/aliyun/tencent/manual |
| RenewDays | Int32 | 续期提前天数。过期前N天自动续期，默认30天 |

**关键特性**：

1. **单域名管理**：
   - 每条记录管理一个域名（字段名改为单数 `Domain`）
   - 支持通配符（如 `*.newlifex.com`）
   - 同一域名可有多个时间段的证书（历史版本）

2. **自动匹配机制**：
   ```csharp
   // 通过 AppDeploy.Urls 自动解析域名并匹配证书
   Urls = "https://sso.newlifex.com"
        ↓ 提取域名
   sso.newlifex.com
        ↓ 查询匹配
   Domain = "*.newlifex.com"  // 通配符匹配
        ↓ 选择有效期内最新证书
   NotBefore ≤ Now < NotAfter
        ↓ 根据节点OS选择格式
   Windows → PfxFile  /  Linux → PemFile
   ```

3. **魔方附件管理**：
   - 文件字段使用魔方附件管理（`ItemType="file"`）
   - 长度50足够（返回相对路径如 `/cube/file?id=123`）
   - 统一附件存储，便于管理

---

## 四、部署模式

### 4.1 模式定义

系统支持四种部署模式，通过 `DeployMode` 枚举定义（v3.7+）：

| 模式 | 值 | 特点 | 适用场景 |
|------|-----|------|---------|
| **Standard** | 10 | 解压到工作目录，直接运行 | **推荐**，大多数应用 |
| **Shadow** | 11 | 解压到影子目录，配置在工作目录 | 热更新，频繁更新的应用 |
| **Hosted** | 12 | 仅解压，由外部宿主运行 | IIS/Nginx托管的应用 |
| **Task** | 13 | 运行一次后完成，不守护 | 脚本、数据库迁移工具 |

### 4.2 Standard 模式（推荐）

```
工作目录结构：
apps/myapp/
├── myapp.zip          # 下载的应用包
├── myapp.exe          # 解压后的可执行文件
├── myapp.dll
├── appsettings.json   # 配置文件
└── logs/              # 日志目录

执行流程：
1. Extract: zip 解压到工作目录
2. Execute: 直接在工作目录运行
```

**适用场景**：
- ? 控制台应用
- ? Web API
- ? 后台服务
- ? 大多数标准应用

### 4.3 Shadow 模式（热更新）

```
目录结构：
apps/myapp/              # 工作目录（配置和数据）
├── myapp.zip
├── appsettings.json    # 配置文件（不会被覆盖）
├── data/               # 数据目录

shadow/myapp-a1b2c3d4/   # 影子目录（可执行文件）
├── myapp.exe
├── myapp.dll
└── *.dll

执行流程：
1. Extract: zip 解压到影子目录
2. 配置文件拷贝到工作目录（如不存在）
3. Execute: 在影子目录运行，工作目录设为 apps/myapp
```

**适用场景**：
- ? 需要保持配置文件的应用
- ? 频繁更新但配置不变
- ? 热更新场景

### 4.4 Hosted 模式（外部托管）

```
工作目录结构：
wwwroot/mysite/
├── web.config         # IIS 配置
├── app_offline.htm    # 维护页面（部署时临时创建）
├── *.dll
└── wwwroot/

执行流程：
1. Extract:
   - 创建 app_offline.htm（网站离线）
   - 备份 web.config
   - 解压 zip 到工作目录
   - 恢复 web.config
   - 删除 app_offline.htm（网站上线）
2. Execute: 不启动进程（由 IIS 托管）
```

**适用场景**：
- ? IIS 托管的 ASP.NET 应用
- ? Nginx 托管的静态网站
- ? 不需要守护的应用

### 4.5 Task 模式（一次性任务）

```
执行流程：
1. Extract: zip 解压到工作目录（如有）
2. Execute: 运行一次
3. 完成后: 设置 Enable = false，不再守护
```

**适用场景**：
- ? 数据库迁移脚本
- ? 初始化工具
- ? 一次性任务

### 4.6 兼容性设计

系统支持新旧两套部署模式值：

| 旧版值 | 旧版名称 | 新版值 | 新版名称 |
|--------|----------|--------|----------|
| 0 | Default | 11 | Shadow |
| 1 | Extract | 12 | Hosted |
| 2 | ExtractAndRun | 10 | Standard |
| 3 | RunOnce | 13 | Task |
| 4 | Multiple | 11 | Shadow + AllowMultiple |

客户端通过数值范围自动识别：
- **0-9**：旧版模式，按映射表转换
- **10+**：新版模式，直接使用

新版客户端（>=v3.7）接收新版模式值（10+），旧版客户端（<v3.7）接收旧版模式值（0-4），平滑过渡。

---

## 五、多版本管理

### 5.1 MultiVersion 核心机制

**功能开关**：`AppDeploy.MultiVersion = true`

**核心能力**：
- 不同节点运行不同版本（根据 OS/Arch/TFM 自动匹配）
- 同一应用支持 Windows/Linux、X64/ARM、net8.0/net10.0 等多个版本
- 自动选择最新的匹配版本

**版本选择规则**：

```csharp
// 伪代码
public AppDeployVersion SelectVersion(AppDeploy app, Node node)
{
    // 1. 过滤启用的版本
    var versions = AppDeployVersion.FindAll(_.DeployId == app.Id & _.Enable == true)
        .OrderByDescending(e => e.Id);  // 最新优先
    
    // 2. 匹配节点平台
    foreach (var ver in versions)
    {
        // 通用版本（OS=0, Arch=0, TFM=""）匹配所有节点
        if (ver.OS == 0 && ver.Arch == 0 && ver.TargetFramework.IsNullOrEmpty())
            return ver;
        
        // 精确匹配
        if (ver.OS == node.OSKind && ver.Arch == node.CpuArch)
        {
            // 框架匹配（向上兼容）
            if (ver.TargetFramework.IsNullOrEmpty() || 
                IsFrameworkCompatible(ver.TargetFramework, node.Frameworks))
                return ver;
        }
    }
    
    return null;
}
```

### 5.2 版本回滚

#### 方案一：禁用新版本（推荐）

**原理**：利用 `Enable` 字段过滤机制

**操作步骤**：

```
场景：回滚到 2024-12-20 的版本

版本列表：
- ID=100, v1.0.0, Arch=Arm64, 2025-01-15, Enable=true  ← 最新（有问题）
- ID=50,  v1.0.0, Arch=Arm64, 2024-12-20, Enable=true  ← 目标稳定版

操作：
1. 找到 ID=100，点击"禁用"
2. 点击"发布"按钮
3. 系统自动选择 ID=50（最新的可用版本）
```

**优点**：
- ? 不需要修改代码
- ? 操作简单直观
- ? 支持灰度回滚（逐步禁用不同平台的新版本）
- ? 可随时恢复（重新启用即可）

#### 方案二：版本命名规范

**建议格式**：`{主版本}.{次版本}.{年}.{月日}`

**示例**：
- `1.0.2025.0115`
- `1.0.2024.1220`

**优点**：
- 版本号天然有序
- 易于识别发布时间
- 直接使用版本号回滚

### 5.3 回滚场景示例

#### 场景1：单平台回滚

```
应用：MyApp (MultiVersion=true)
版本列表：
- ID=101, v1.0.0, Windows/X64,  2025-01-15, Enable=true
- ID=100, v1.0.0, Linux/Arm64,  2025-01-15, Enable=true  ← 有问题
- ID=51,  v1.0.0, Windows/X64,  2024-12-20, Enable=true
- ID=50,  v1.0.0, Linux/Arm64,  2024-12-20, Enable=true  ← 稳定版

操作：
1. 禁用 ID=100
2. 发布

结果：
- Windows 节点继续使用 ID=101
- ARM 节点自动回滚到 ID=50
```

#### 场景2：全平台回滚

```
需求：所有平台回滚到 2024-12-20

操作：
1. 禁用所有 2024-12-20 之后的版本（ID=100, 101）
2. 发布

结果：
- 所有节点都使用 2024-12-20 的版本
```

#### 场景3：灰度回滚

```
需求：先回滚测试环境，验证后再回滚生产

操作：
1. 在测试节点上禁用新版本，观察运行情况
2. 确认无问题后，在生产节点上禁用新版本
```

---

## 六、SSL证书管理

### 6.1 设计理念

**核心原则**：
- ? **无需项目归属**：全公司共用，中小企业无需区分项目
- ? **单域名管理**：每条记录一个域名，简化逻辑
- ? **自动匹配**：通过 `AppDeploy.Urls` 自动解析域名并匹配证书
- ? **历史版本**：同一域名可有多个时间段的证书

### 6.2 域名匹配逻辑

```csharp
// 伪代码
public SslCertificate FindByDomain(String domain)
{
    var now = DateTime.Now;
    
    // 查找所有启用且有效的证书
    var certs = SslCertificate.FindAll(
        _.Enable == true & 
        _.NotBefore <= now & 
        _.NotAfter > now
    ).OrderByDescending(e => e.NotAfter);  // 最新优先
    
    // 精确匹配优先
    var exactMatch = certs.FirstOrDefault(e => e.Domain.EqualIgnoreCase(domain));
    if (exactMatch != null) return exactMatch;
    
    // 通配符匹配
    foreach (var cert in certs)
    {
        // *.newlifex.com 匹配 sso.newlifex.com
        if (cert.Domain.StartsWith("*."))
        {
            var suffix = cert.Domain.Substring(2);
            if (domain.EndsWith(suffix, StringComparison.OrdinalIgnoreCase))
                return cert;
        }
    }
    
    return null;
}
```

### 6.3 使用场景

#### 场景1：单域名证书

```
证书：
├── Domain: sso.newlifex.com
├── NotAfter: 2026-01-01
└── PfxFile: /cube/file?id=123

应用：
├── Urls: https://sso.newlifex.com
└── 精确匹配 ?
```

#### 场景2：通配符证书

```
证书：
├── Domain: *.newlifex.com
├── NotAfter: 2026-01-01
└── PfxFile: /cube/file?id=123

应用A: Urls = https://sso.newlifex.com   ? 匹配
应用B: Urls = https://www.newlifex.com   ? 匹配
应用C: Urls = https://api.newlifex.com   ? 匹配
```

#### 场景3：多域名需求

**方式1：创建多条记录**（相同证书文件）

```
证书1: Domain = sso.newlifex.com, PfxFile = /cube/file?id=123
证书2: Domain = www.newlifex.com, PfxFile = /cube/file?id=123
```

**方式2：使用通配符**（推荐）

```
证书1: Domain = *.newlifex.com, PfxFile = /cube/file?id=123
```

### 6.4 自动续期

**支持的提供商**：
- Let's Encrypt（letsencrypt）
- 阿里云（aliyun）
- 腾讯云（tencent）
- 手动上传（manual）

**自动续期流程**：

```
CertRenewJob 定时任务（每天执行）
    │
    ▼
查找即将过期的证书（NotAfter ≤ 今天 + RenewDays）
    │
    ├── AutoRenew=true
    │       │
    │       └── 调用续期接口（Let's Encrypt/阿里云/腾讯云）
    │              ├── 验证域名所有权
    │              ├── 申请新证书
    │              ├── 更新证书文件
    │              └── 更新 NotAfter 字段
    │
    └── AutoRenew=false
            │
            └── 发送告警（邮件/钉钉/企微）
```

---

## 七、依赖项管理

### 7.1 设计理念

**核心思路**：**驱动/插件作为独立 `AppDeploy` 部署集**

**优势**：
- ? 复用平台能力：多版本管理、多平台支持、回滚能力
- ? 独立生命周期：驱动可独立升级，不影响业务应用
- ? 全局共享：一次配置，所有项目共用
- ? 灵活依赖：应用可选择性依赖，按需部署

### 7.2 创建全局驱动

```
示例：创建 DM8 数据库驱动

AppDeploy:
├── ProjectId: 0（全局资源）
├── Category: driver
├── Name: dm8-driver
├── Mode: Hosted（仅解压，不启动进程）
├── WorkingDirectory: ../Plugins/DmProvider
└── 版本：
    ├── v8.1.2 (OS=Windows, Arch=X64, TFM=net8.0)
    ├── v8.1.2 (OS=Linux, Arch=Arm64, TFM=net8.0)
    └── v8.1.2 (OS=Any, Arch=Any, TFM=net45) ← 通用版本
```

### 7.3 应用声明依赖

```
AppDeploy:
├── Name: MyApp
└── Dependencies: dm8-driver;redis-plugin

格式：驱动/插件名称，分号分隔
来源：可来自全局项目（ProjectId=0）或本项目
```

### 7.4 依赖检查逻辑

```
DeployService.CheckDependencies(app, node)
    │
    ▼
解析 app.Dependencies = "dm8-driver;redis-plugin"
    │
    ├── 查找 dm8-driver
    │       │
    │       ├── 优先本项目（ProjectId = app.ProjectId）
    │       └── 其次全局（ProjectId = 0）
    │       │
    │       ├── 检查是否已部署到目标节点
    │       │       ├── 已部署 → 跳过
    │       │       └── 未部署 → 自动创建 AppDeployNode
    │       │                  └── 异步触发发布
    │       │
    │       └── 等待依赖就绪
    │
    └── 查找 redis-plugin（同上）
            │
            ▼
所有依赖就绪后，发布主应用
```

### 7.5 部署节点页面操作

```
多选发布：
?? MyApp 主包（v1.0.2025.0701）
?? dm8-driver（v8.1.2.141）
?? redis-plugin（v2.0.1）
    ↓
[ 一键发布 ] → 按依赖顺序发布
```

---

## 八、部署流程

### 8.1 完整流程图

```
┌─────────────────────────────────────────────────────────────┐
│ 1. 上传应用包                                                │
│    用户 ──[上传 ZIP]──> Stardust.Server                      │
│           ├── 保存到魔方附件                                 │
│           ├── 解析元数据（OS/Arch/TFM）                      │
│           └── 记录 AppDeployVersion                          │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│ 2. 配置应用                                                  │
│    ├── AppDeploy.Name = "MyApp"                              │
│    ├── AppDeploy.Urls = "https://sso.newlifex.com"          │
│    │       └── 自动匹配 → SslCertificate.Domain             │
│    └── AppDeploy.Dependencies = "dm8-driver;redis-plugin"    │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│ 3. 点击发布                                                  │
│    DeployService.BuildDeployInfo()                           │
│    ├── 选择版本（MultiVersion 匹配）                        │
│    ├── 查找证书（Domain 匹配）                               │
│    ├── 检查依赖（自动关联节点）                             │
│    └── 构建 DeployInfo                                       │
│           ├── Service (ServiceInfo)                          │
│           ├── Certificate (CertInfo)                         │
│           └── Dependencies (DeployInfo[])                    │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│ 4. 下发指令                                                  │
│    ├── WebSocket 推送（实时）                                │
│    │       └── /deploy/publish                               │
│    └── HTTP 轮询（轮询，每分钟）                             │
│            └── /node/getDeploy                               │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│ 5. 客户端处理                                                │
│    StarAgent.ServiceManager                                  │
│    ├── OnInstall(deployId, serviceName)                      │
│    │       ├── PullService() ──> 拉取 DeployInfo            │
│    │       ├── Download ZIP ──> 下载应用包                  │
│    │       ├── Download SSL Cert ──> 下载证书               │
│    │       ├── Deploy Dependencies ──> 部署依赖             │
│    │       ├── StopService() ──> 停止旧进程                 │
│    │       └── StartService() ──> 启动新进程                │
│    │              ├── 选择部署策略（Standard/Shadow/...）   │
│    │              ├── Extract ZIP                            │
│    │              ├── Execute Process                        │
│    │              └── StartMonitor（文件监控）              │
│    │                                                          │
│    ├── OnStart(serviceName)                                  │
│    ├── OnStop(serviceName)                                   │
│    ├── OnRestart(serviceName)                                │
│    └── OnUninstall(serviceName)                              │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│ 6. 守护监控                                                  │
│    ServiceManager.DoWork() 定时任务（30秒）                  │
│    ├── 检查进程状态                                          │
│    ├── 检查内存限制                                          │
│    ├── 检查文件变化（ReloadOnChange）                       │
│    └── 上报心跳（LastActive）                                │
└─────────────────────────────────────────────────────────────┘
```

### 8.2 关键接口

#### 服务端接口

| 接口 | 说明 |
|------|------|
| `/deploy/publish` | WebSocket 推送发布指令 |
| `/node/getDeploy` | HTTP 轮询获取部署信息 |
| `/node/ping` | 节点心跳上报 |
| `/deploy/start` | 启动应用 |
| `/deploy/stop` | 停止应用 |
| `/deploy/restart` | 重启应用 |

#### 客户端处理

| 方法 | 说明 |
|------|------|
| `ServiceManager.OnInstall()` | 安装/发布应用 |
| `ServiceManager.OnStart()` | 启动应用 |
| `ServiceManager.OnStop()` | 停止应用 |
| `ServiceManager.OnRestart()` | 重启应用 |
| `ServiceManager.OnUninstall()` | 卸载应用 |
| `ServiceController.Check()` | 健康检查，接管/重启 |

---

## 九、客户端架构

### 9.1 组件关系

```
┌─────────────────────────────────────────────────────────────┐
│                      ServiceManager                          │
│  ┌─────────────────────────────────────────────────────────┐│
│  │ - 管理多个 ServiceController                            ││
│  │ - 处理服务端指令（安装/启动/停止/重启/卸载）             ││
│  │ - 定时健康检查（30秒）                                  ││
│  │ - 上报/拉取应用配置                                     ││
│  └─────────────────────────────────────────────────────────┘│
└──────────────────────────┬──────────────────────────────────┘
                           │ 1:N
        ┌──────────────────┼──────────────────┐
        ▼                  ▼                  ▼
┌───────────────┐  ┌───────────────┐  ┌───────────────┐
│ServiceController│ │ServiceController│ │ServiceController│
│   (MyApp)     │  │  (dm8-driver)  │  │(redis-plugin) │
└───────┬───────┘  └───────┬───────┘  └───────┬───────┘
        │                  │                  │
        ▼                  ▼                  ▼
┌───────────────┐  ┌───────────────┐  ┌───────────────┐
│IDeployStrategy│  │IDeployStrategy│  │IDeployStrategy│
│  (Standard)   │  │   (Hosted)    │  │   (Hosted)    │
└───────────────┘  └───────────────┘  └───────────────┘
```

### 9.2 守护机制

```
ServiceManager.DoWork() 定时任务（30秒）
    │
    ▼
遍历 Services
    │
    ├── 服务已禁用 ──> StopService()
    │
    ├── 配置已改变 ──> Stop + Start（重载）
    │
    └── 服务已启用 ──> StartService()
            │
            ▼
    ServiceController.Check()
            │
            ├── 进程存在
            │       ├── 检查内存限制 ──> 超限 → Stop + Start
            │       └── 检查文件变化 ──> ReloadOnChange=true → Stop + Start
            │
            ├── 进程不存在但有 ProcessId
            │       └── 尝试按 ID 查找并接管
            │
            ├── 进程不存在但有 ProcessName
            │       └── 尝试按名称查找并接管
            │
            └── 都找不到 ──> Start() 启动新进程
```

### 9.3 部署策略接口

```csharp
public interface IDeployStrategy
{
    DeployMode Mode { get; }              // 部署模式
    Boolean NeedGuardian { get; }         // 是否需要守护
    Boolean AllowTakeOver { get; }        // 是否允许接管
    
    Boolean Extract(DeployContext ctx);   // 解压部署包
    Process Execute(DeployContext ctx);   // 执行应用
}

实现类：
├── StandardDeployStrategy   (Standard模式)
├── ShadowDeployStrategy     (Shadow模式)
├── HostedStrategy           (Hosted模式)
└── TaskStrategy             (Task模式)
```

---

## 十、最佳实践

### 10.1 版本命名规范

**推荐格式**：`{主版本}.{次版本}.{年}.{月日}`

**示例**：
- `1.0.2025.0701`
- `1.0.2024.1220`
- `2.3.2025.0115`

**优点**：
- 版本号天然有序
- 易于识别发布时间
- 直接使用版本号回滚

### 10.2 上传版本时的建议

1. **填写准确的平台信息**：
   - OS：Windows/Linux/...
   - Arch：X64/Arm64/...
   - TargetFramework：net8.0/net10.0/...

2. **使用描述字段**：
   - 记录变更内容
   - 标记特殊版本（如 LTS、Beta）

3. **包名规范**：
   - 文件名包含平台标识：`myapp-win-x64.zip`
   - 设置 PackageName 字段，避免错误上传

### 10.3 回滚操作建议

1. **优先使用"禁用"方式回滚**：
   - 不删除版本，保留历史记录
   - 可随时恢复（重新启用）

2. **保留回滚历史**：
   - 在部署历史中记录回滚原因
   - 便于追溯问题

3. **灰度回滚**：
   - 先回滚测试环境
   - 观察运行情况后再回滚生产环境

### 10.4 SSL证书管理建议

1. **通配符证书**（推荐）：
   - 一个证书覆盖多个子域名
   - 减少管理复杂度

2. **自动续期**：
   - 集成 Let's Encrypt
   - 设置 RenewDays = 30（提前30天续期）

3. **监控过期时间**：
   - 定期检查 NotAfter 字段
   - 设置告警（过期前7天）

### 10.5 依赖项管理建议

1. **全局驱动**：
   - 驱动设置为全局（ProjectId=0）
   - 所有项目共用

2. **独立版本管理**：
   - 驱动可独立升级
   - 不影响业务应用

3. **按需部署**：
   - 应用可选择性依赖
   - 减少不必要的部署

### 10.6 部署模式选择

| 场景 | 推荐模式 | 理由 |
|------|---------|------|
| 大多数应用 | **Standard** | 简单直接，易于理解 |
| 频繁更新的应用 | **Shadow** | 保持配置文件，热更新 |
| IIS/Nginx 托管 | **Hosted** | 仅解压，由外部宿主运行 |
| 数据库迁移工具 | **Task** | 运行一次后完成，不守护 |

### 10.7 滚动发布

**配置节点延迟**：

```
节点A: Delay=0     （立即发布）
节点B: Delay=60    （延迟60秒）
节点C: Delay=120   （延迟120秒）

结果：
1. 节点A先发布，观察运行情况
2. 60秒后，节点B发布
3. 120秒后，节点C发布
```

**优点**：
- 降低风险
- 便于及时发现问题
- 支持灰度发布

---

## 十一、故障排查

### 11.1 常见问题

#### 问题1：发布后节点未更新

**可能原因**：
1. 节点未连接到服务端
2. 节点上的 StarAgent 未运行
3. WebSocket 连接断开，HTTP 轮询未触发

**排查步骤**：
```
1. 检查节点状态：LastActive 字段
2. 检查 StarAgent 日志：logs/staragent.log
3. 检查服务端日志：发布指令是否下发
4. 手动触发：/node/getDeploy 接口
```

#### 问题2：进程启动失败

**可能原因**：
1. 启动文件不正确（FileName 字段）
2. 工作目录不存在（WorkingDirectory 字段）
3. 权限不足（UserName 字段）
4. 端口被占用（Port 字段）

**排查步骤**：
```
1. 检查 StarAgent 日志：启动失败原因
2. 检查应用日志：工作目录/logs
3. 检查进程状态：ProcessId 字段
4. 手动启动：验证启动命令
```

#### 问题3：证书未自动匹配

**可能原因**：
1. Domain 字段与 Urls 不匹配
2. 证书已过期（NotAfter < Now）
3. 证书未启用（Enable = false）

**排查步骤**：
```
1. 检查 AppDeploy.Urls：提取域名
2. 检查 SslCertificate.Domain：通配符匹配
3. 检查证书有效期：NotBefore ≤ Now < NotAfter
4. 检查证书启用状态：Enable = true
```

#### 问题4：依赖项未自动部署

**可能原因**：
1. Dependencies 字段拼写错误
2. 依赖部署集不存在
3. 依赖部署集未启用（Enable = false）

**排查步骤**：
```
1. 检查 AppDeploy.Dependencies：名称是否正确
2. 检查依赖部署集：Name 字段
3. 检查依赖节点：AppDeployNode 是否已创建
4. 检查发布日志：自动部署是否成功
```

### 11.2 日志位置

| 组件 | 日志位置 |
|------|---------|
| **Stardust.Web** | `Logs/*.log` |
| **Stardust.Server** | `Logs/*.log` |
| **StarAgent** | `Logs/staragent.log` |
| **应用日志** | 工作目录/`logs/*.log` |

### 11.3 关键字段检查清单

#### AppDeploy

- [ ] Name 唯一
- [ ] Version 正确
- [ ] MultiVersion 开关
- [ ] Urls 格式正确
- [ ] Dependencies 名称正确
- [ ] FileName 存在

#### AppDeployNode

- [ ] Enable = true
- [ ] Version 匹配
- [ ] LastActive 最近
- [ ] ProcessId 正确
- [ ] IP 地址正确

#### AppDeployVersion

- [ ] Enable = true
- [ ] Url 可访问
- [ ] Hash 正确
- [ ] OS/Arch/TFM 匹配

#### SslCertificate

- [ ] Domain 匹配
- [ ] Enable = true
- [ ] NotAfter > Now
- [ ] PfxFile/PemFile 存在

---
